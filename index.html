<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Net Worth Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:white;border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    h1{color:#667eea;margin-bottom:10px;font-size:2.2em}
    .subtitle{color:#666;margin-bottom:30px;font-size:0.95em}
    .total-section{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:15px;margin-bottom:30px;text-align:center}
    .total-amount{font-size:3em;font-weight:bold;margin:10px 0}
    .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:30px}
    .chart-container{background:white;padding:20px;border-radius:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .chart-container h2{color:#333;margin-bottom:20px;font-size:1.3em}
    .tabs{display:flex;gap:10px;margin-bottom:30px;border-bottom:2px solid #e0e0e0}
    .tab{padding:15px 30px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:1em;font-weight:600;color:#666;transition:all 0.3s}
    .tab.active{color:#667eea;border-bottom-color:#667eea}
    .tab:hover{color:#667eea}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .account-card{background:#f8f9fa;padding:25px;border-radius:12px;margin-bottom:20px}
    .account-card h3{color:#333;margin-bottom:20px;font-size:1.3em}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
    label{display:block;margin-bottom:5px;color:#555;font-size:0.9em;font-weight:500}
    input,select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em}
    input:focus,select:focus{outline:none;border-color:#667eea}
    button{padding:12px 24px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:all 0.3s;margin:5px}
    .btn-primary{background:#667eea;color:white}
    .btn-primary:hover{background:#5568d3;transform:translateY(-2px)}
    .btn-success{background:#27ae60;color:white}
    .btn-warning{background:#f39c12;color:white}
    .btn-danger{background:#e74c3c;color:white}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .stat-card{background:white;padding:20px;border-radius:10px;text-align:center}
    .stat-label{color:#666;font-size:0.85em;margin-bottom:5px}
    .stat-value{font-size:1.5em;font-weight:bold;color:#667eea}
    .list{margin-top:20px;max-height:400px;overflow-y:auto}
    .item{background:white;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid #667eea}
    .transaction-income{border-left-color:#27ae60}
    .transaction-expense{border-left-color:#e74c3c}
    .item-details{flex:1}
    .item-type{font-weight:bold;margin-bottom:5px}
    .item-date{color:#999;font-size:0.85em}
    .item-amount{font-size:1.2em;font-weight:bold}
    .amount-positive{color:#27ae60}
    .amount-negative{color:#e74c3c}
    .delete-btn{background:#e74c3c;color:white;padding:8px 12px;border-radius:5px;cursor:pointer;font-size:0.85em;margin-left:10px;border:none}
    .filter-section{background:white;padding:15px;border-radius:10px;margin-bottom:20px;display:flex;gap:15px;align-items:flex-end}
    .filter-group{flex:1}
    .holding-info{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;font-size:0.9em}
    .upload-section{background:#e8f5e9;padding:15px;border-radius:10px;margin-bottom:20px;border:2px dashed #27ae60}
    .upload-section h4{color:#27ae60;margin-bottom:10px}
    .file-input{display:none}
    .upload-btn{background:#27ae60;color:white;padding:10px 20px;border-radius:8px;cursor:pointer;display:inline-block;margin:5px}
    .upload-btn:hover{background:#229954}
  </style>
</head>
<body>
  <div class="container">
    <h1>üí∞ Net Worth Tracker</h1>
    <p class="subtitle">Track your finances across all accounts</p>

    <div class="total-section">
      <div>Total Net Worth</div>
      <div class="total-amount" id="total">$0.00</div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h2>üìà Net Worth History</h2>
        <canvas id="chart1"></canvas>
      </div>
      <div class="chart-container">
        <h2>ü•ß Portfolio Breakdown</h2>
        <canvas id="chart2"></canvas>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="0">üí≥ Checking</button>
      <button class="tab" data-tab="1">üìà Roth IRA</button>
      <button class="tab" data-tab="2">üè¶ 401k</button>
    </div>

    <div id="tab0" class="tab-content active">
      <div class="account-card">
        <h3>üí≥ Checking Account</h3>
        
        <div class="upload-section">
          <h4>üìÅ Upload Transactions from Excel</h4>
          <p style="font-size:0.9em;color:#666;margin-bottom:10px">Excel format: Date | Type | Amount | Description</p>
          <input type="file" id="uploadChecking" class="file-input" accept=".xlsx,.xls,.csv">
          <label for="uploadChecking" class="upload-btn">Choose Excel File</label>
        </div>

        <div class="form-row">
          <div><label>Starting Balance</label><input type="number" id="startBal" step="0.01"></div>
          <div style="display:flex;align-items:flex-end"><button class="btn-warning" id="setBalBtn">Set Balance</button></div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Balance</div><div class="stat-value" id="bal">$0.00</div></div>
          <div class="stat-card"><div class="stat-label">Income</div><div class="stat-value amount-positive" id="inc">$0.00</div></div>
          <div class="stat-card"><div class="stat-label">Expenses</div><div class="stat-value amount-negative" id="exp">$0.00</div></div>
        </div>
        <div class="filter-section">
          <div class="filter-group"><label>Period</label>
            <select id="period">
              <option value="all">All Time</option>
              <option value="thisMonth">This Month</option>
              <option value="lastMonth">Last Month</option>
              <option value="thisYear">This Year</option>
              <option value="lastYear">Last Year</option>
            </select>
          </div>
          <div class="filter-group"><label>Custom Month</label><input type="month" id="custom"></div>
        </div>
        <div class="chart-container"><h2>Income vs Expenses</h2><canvas id="chart3"></canvas></div>
        <div class="form-row">
          <div><label>Type</label><select id="type"><option value="income">Income</option><option value="expense">Expense</option></select></div>
          <div><label>Amount</label><input type="number" id="amt" step="0.01" min="0"></div>
          <div><label>Description</label><input type="text" id="desc" list="descList"><datalist id="descList"></datalist></div>
        </div>
        <button class="btn-primary" id="addTxn">Add Transaction</button>
        <div class="list" id="txnList"></div>
      </div>
    </div>

    <div id="tab1" class="tab-content">
      <div class="account-card">
        <h3>üìà Roth IRA</h3>
        
        <div class="upload-section">
          <h4>üìÅ Upload Holdings from Excel</h4>
          <p style="font-size:0.9em;color:#666;margin-bottom:10px">Excel format: Ticker | Shares | Price</p>
          <input type="file" id="uploadRoth" class="file-input" accept=".xlsx,.xls,.csv">
          <label for="uploadRoth" class="upload-btn">Choose Excel File</label>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Portfolio Value</div><div class="stat-value" id="rVal">$0.00</div></div>
          <div class="stat-card"><div class="stat-label">Contributions</div><div class="stat-value" id="rCont">$0.00</div></div>
          <div class="stat-card"><div class="stat-label">Gain/Loss</div><div class="stat-value" id="rGain">$0.00</div></div>
        </div>
        <button class="btn-warning" id="updR">üîÑ Update All Prices</button>
        <div class="form-row">
          <div><label>Add Contribution</label><input type="number" id="rContAmt" step="0.01" min="0"></div>
          <div style="display:flex;align-items:flex-end"><button class="btn-success" id="addRCont">Add</button></div>
        </div>
        <div class="form-row">
          <div><label>Ticker</label><input type="text" id="rTick"></div>
          <div><label>Shares</label><input type="number" id="rShares" step="0.0001" min="0"></div>
          <div><label>Price (auto-fetch if empty)</label><input type="number" id="rPrice" step="0.01" min="0"></div>
        </div>
        <button class="btn-primary" id="addRHold">Add/Update Holding</button>
        <div class="list" id="rList"></div>
      </div>
    </div>

    <div id="tab2" class="tab-content">
      <div class="account-card">
        <h3>üè¶ 401k Account</h3>
        
        <div class="upload-section">
          <h4>üìÅ Upload Holdings from Excel</h4>
          <p style="font-size:0.9em;color:#666;margin-bottom:10px">Excel format: Ticker | Shares | Price</p>
          <input type="file" id="upload401k" class="file-input" accept=".xlsx,.xls,.csv">
          <label for="upload401k" class="upload-btn">Choose Excel File</label>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Portfolio Value</div><div class="stat-value" id="kVal">$0.00</div></div>
          <div class="stat-card"><div class="stat-label">Contributions</div><div class="stat-value" id="kCont">$0.00</div></div>
          <div class="stat-card"><div class="stat-label">Gain/Loss</div><div class="stat-value" id="kGain">$0.00</div></div>
        </div>
        <button class="btn-warning" id="updK">üîÑ Update All Prices</button>
        <div class="form-row">
          <div><label>Add Contribution</label><input type="number" id="kContAmt" step="0.01" min="0"></div>
          <div style="display:flex;align-items:flex-end"><button class="btn-success" id="addKCont">Add</button></div>
        </div>
        <div class="form-row">
          <div><label>Ticker</label><input type="text" id="kTick"></div>
          <div><label>Shares</label><input type="number" id="kShares" step="0.0001" min="0"></div>
          <div><label>Price (auto-fetch if empty)</label><input type="number" id="kPrice" step="0.01" min="0"></div>
        </div>
        <button class="btn-primary" id="addKHold">Add/Update Holding</button>
        <div class="list" id="kList"></div>
      </div>
    </div>
  </div>

  <script>
    let d={c:{b:0,t:[]},r:{h:[],c:0},k:{h:[],c:0},hist:[],descs:['Salary','Paycheck','Bonus','Freelance','Groceries','Rent','Utilities','Gas','Restaurant','Shopping','Entertainment','Healthcare','Insurance','Transportation']};
    let ch1,ch2,ch3,fp='all';

    window.onload=()=>{
      load();
      initCh();
      updDescs();
      upd();
      
      document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('tab'+t.dataset.tab).classList.add('active');
      });

      document.getElementById('setBalBtn').onclick=()=>{
        let v=parseFloat(document.getElementById('startBal').value);
        if(isNaN(v))return alert('Invalid amount');
        if(d.c.t.length&&!confirm('This will affect current balance. Continue?'))return;
        d.c.b=v;
        document.getElementById('startBal').value='';
        save();upd();alert('Balance set!');
      };

      document.getElementById('addTxn').onclick=()=>{
        let ty=document.getElementById('type').value;
        let am=parseFloat(document.getElementById('amt').value);
        let de=document.getElementById('desc').value.trim();
        if(!am||am<=0)return alert('Invalid amount');
        if(!de)return alert('Enter description');
        if(!d.descs.includes(de)){d.descs.push(de);updDescs();}
        d.c.t.push({type:ty,amount:am,description:de,date:new Date().toISOString()});
        document.getElementById('amt').value='';
        document.getElementById('desc').value='';
        save();upd();
      };

      document.getElementById('period').onchange=document.getElementById('custom').onchange=()=>{
        fp=document.getElementById('custom').value?'custom':document.getElementById('period').value;
        upd();
      };

      document.getElementById('addRCont').onclick=()=>{
        let v=parseFloat(document.getElementById('rContAmt').value);
        if(!v||v<=0)return alert('Invalid amount');
        d.r.c+=v;
        document.getElementById('rContAmt').value='';
        save();upd();
      };

      document.getElementById('addRHold').onclick=async()=>{
        let ti=document.getElementById('rTick').value.toUpperCase().trim();
        let sh=parseFloat(document.getElementById('rShares').value);
        let pr=parseFloat(document.getElementById('rPrice').value);
        if(!ti||!sh||sh<=0)return alert('Enter ticker and shares');
        if(!pr||pr<=0){
          alert('Fetching price...');
          pr=await fetchP(ti);
          if(!pr)return alert('Could not fetch price');
        }
        let idx=d.r.h.findIndex(x=>x.ticker===ti);
        if(idx>=0)d.r.h[idx]={ticker:ti,shares:sh,price:pr};
        else d.r.h.push({ticker:ti,shares:sh,price:pr});
        document.getElementById('rTick').value='';
        document.getElementById('rShares').value='';
        document.getElementById('rPrice').value='';
        save();upd();
      };

      document.getElementById('updR').onclick=async()=>{
        if(!d.r.h.length)return alert('No holdings');
        alert('Updating...');
        let cnt=0;
        for(let h of d.r.h){
          let p=await fetchP(h.ticker);
          if(p){h.price=p;cnt++;}
        }
        save();upd();alert(`Updated ${cnt}/${d.r.h.length} prices`);
      };

      document.getElementById('addKCont').onclick=()=>{
        let v=parseFloat(document.getElementById('kContAmt').value);
        if(!v||v<=0)return alert('Invalid amount');
        d.k.c+=v;
        document.getElementById('kContAmt').value='';
        save();upd();
      };

      document.getElementById('addKHold').onclick=async()=>{
        let ti=document.getElementById('kTick').value.toUpperCase().trim();
        let sh=parseFloat(document.getElementById('kShares').value);
        let pr=parseFloat(document.getElementById('kPrice').value);
        if(!ti||!sh||sh<=0)return alert('Enter ticker and shares');
        if(!pr||pr<=0){
          alert('Fetching price...');
          pr=await fetchP(ti);
          if(!pr)return alert('Could not fetch price');
        }
        let idx=d.k.h.findIndex(x=>x.ticker===ti);
        if(idx>=0)d.k.h[idx]={ticker:ti,shares:sh,price:pr};
        else d.k.h.push({ticker:ti,shares:sh,price:pr});
        document.getElementById('kTick').value='';
        document.getElementById('kShares').value='';
        document.getElementById('kPrice').value='';
        save();upd();
      };

      document.getElementById('updK').onclick=async()=>{
        if(!d.k.h.length)return alert('No holdings');
        alert('Updating...');
        let cnt=0;
        for(let h of d.k.h){
          let p=await fetchP(h.ticker);
          if(p){h.price=p;cnt++;}
        }
        save();upd();alert(`Updated ${cnt}/${d.k.h.length} prices`);
      };

      document.getElementById('uploadChecking').onchange=async(e)=>{
        let file=e.target.files[0];
        if(!file)return;
        let data=await file.arrayBuffer();
        let wb=XLSX.read(data);
        let ws=wb.Sheets[wb.SheetNames[0]];
        let rows=XLSX.utils.sheet_to_json(ws,{header:1});
        let added=0;
        for(let i=1;i<rows.length;i++){
          let row=rows[i];
          if(!row[0]||!row[1]||!row[2]||!row[3])continue;
          let dt=row[0];
          if(typeof dt==='number')dt=new Date((dt-25569)*86400*1000).toISOString();
          else dt=new Date(dt).toISOString();
          let ty=row[1].toString().toLowerCase().includes('income')?'income':'expense';
          let am=parseFloat(row[2]);
          let de=row[3].toString();
          if(!d.descs.includes(de))d.descs.push(de);
          d.c.t.push({type:ty,amount:am,description:de,date:dt});
          added++;
        }
        updDescs();save();upd();
        alert(`Added ${added} transactions!`);
        e.target.value='';
      };

      document.getElementById('uploadRoth').onchange=async(e)=>{
        let file=e.target.files[0];
        if(!file)return;
        let data=await file.arrayBuffer();
        let wb=XLSX.read(data);
        let ws=wb.Sheets[wb.SheetNames[0]];
        let rows=XLSX.utils.sheet_to_json(ws,{header:1});
        let added=0;
        for(let i=1;i<rows.length;i++){
          let row=rows[i];
          if(!row[0]||!row[1])continue;
          let ti=row[0].toString().toUpperCase().trim();
          let sh=parseFloat(row[1]);
          let pr=row[2]?parseFloat(row[2]):null;
          if(!pr){
            pr=await fetchP(ti);
            if(!pr){alert(`Could not fetch price for ${ti}, skipping`);continue;}
          }
          let idx=d.r.h.findIndex(x=>x.ticker===ti);
          if(idx>=0)d.r.h[idx]={ticker:ti,shares:sh,price:pr};
          else{d.r.h.push({ticker:ti,shares:sh,price:pr});added++;}
        }
        save();upd();
        alert(`Added/updated ${added} holdings!`);
        e.target.value='';
      };

      document.getElementById('upload401k').onchange=async(e)=>{
        let file=e.target.files[0];
        if(!file)return;
        let data=await file.arrayBuffer();
        let wb=XLSX.read(data);
        let ws=wb.Sheets[wb.SheetNames[0]];
        let rows=XLSX.utils.sheet_to_json(ws,{header:1});
        let added=0;
        for(let i=1;i<rows.length;i++){
          let row=rows[i];
          if(!row[0]||!row[1])continue;
          let ti=row[0].toString().toUpperCase().trim();
          let sh=parseFloat(row[1]);
          let pr=row[2]?parseFloat(row[2]):null;
          if(!pr){
            pr=await fetchP(ti);
            if(!pr){alert(`Could not fetch price for ${ti}, skipping`);continue;}
          }
          let idx=d.k.h.findIndex(x=>x.ticker===ti);
          if(idx>=0)d.k.h[idx]={ticker:ti,shares:sh,price:pr};
          else{d.k.h.push({ticker:ti,shares:sh,price:pr});added++;}
        }
        save();upd();
        alert(`Added/updated ${added} holdings!`);
        e.target.value='';
      };
    };

    function updDescs(){
      document.getElementById('descList').innerHTML=d.descs.map(x=>`<option value="${x}">`).join('');
    }

    function filt(){
      let now=new Date(),cm=document.getElementById('custom').value;
      return d.c.t.filter(t=>{
        let td=new Date(t.date);
        if(fp==='custom'&&cm){
          let[y,m]=cm.split('-');
          return td.getFullYear()===parseInt(y)&&td.getMonth()===parseInt(m)-1;
        }
        if(fp==='thisMonth')return td.getMonth()===now.getMonth()&&td.getFullYear()===now.getFullYear();
        if(fp==='lastMonth'){
          let lm=new Date(now.getFullYear(),now.getMonth()-1);
          return td.getMonth()===lm.getMonth()&&td.getFullYear()===lm.getFullYear();
        }
        if(fp==='thisYear')return td.getFullYear()===now.getFullYear();
        if(fp==='lastYear')return td.getFullYear()===now.getFullYear()-1;
        return true;
      });
    }

    function calcBal(){return d.c.b+d.c.t.reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);}
    function calcInc(){return filt().filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);}
    function calcExp(){return filt().filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);}
    function calcRVal(){return d.r.h.reduce((s,h)=>s+(h.shares*h.price),0);}
    function calcKVal(){return d.k.h.reduce((s,h)=>s+(h.shares*h.price),0);}

    async function fetchP(tk){
      try{
        let r=await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${tk}`);
        let j=await r.json();
        return j.chart.result[0].meta.regularMarketPrice;
      }catch{
        try{
          let r=await fetch(`https://query2.finance.yahoo.com/v8/finance/chart/${tk}`);
          let j=await r.json();
          return j.chart.result[0].meta.regularMarketPrice;
        }catch{return null;}
      }
    }

    function upd(){
      let cb=calcBal(),rv=calcRVal(),kv=calcKVal(),tot=cb+rv+kv;
      document.getElementById('total').textContent=fmt(tot);
      document.getElementById('bal').textContent=fmt(cb);
      document.getElementById('inc').textContent=fmt(calcInc());
      document.getElementById('exp').textContent=fmt(calcExp());
      document.getElementById('rVal').textContent=fmt(rv);
      document.getElementById('rCont').textContent=fmt(d.r.c);
      document.getElementById('rGain').textContent=fmt(rv-d.r.c);
      document.getElementById('kVal').textContent=fmt(kv);
      document.getElementById('kCont').textContent=fmt(d.k.c);
      document.getElementById('kGain').textContent=fmt(kv-d.k.c);
      updTxns();updRHolds();updKHolds();snap(cb,rv,kv,tot);updCh();
    }

    function updTxns(){
      let lst=document.getElementById('txnList'),f=filt();
      if(!f.length)return lst.innerHTML='<p style="text-align:center;color:#999;padding:20px">No transactions</p>';
      lst.innerHTML=[...f].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>{
        let i=d.c.t.indexOf(t);
        return`<div class="item transaction-${t.type}"><div class="item-details"><div class="item-type">${t.type==='income'?'üí∞':'üí∏'} ${t.description}</div><div class="item-date">${fmtD(t.date)}</div></div><div><span class="item-amount ${t.type==='income'?'amount-positive':'amount-negative'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</span><button class="delete-btn" onclick="delT(${i})">Del</button></div></div>`;
      }).join('');
    }

    function updRHolds(){
      let lst=document.getElementById('rList');
      if(!d.r.h.length)return lst.innerHTML='<p style="text-align:center;color:#999;padding:20px">No holdings</p>';
      lst.innerHTML=d.r.h.map((h,i)=>{
        let v=h.shares*h.price;
        return`<div class="item"><div style="flex:1"><div style="font-weight:bold;font-size:1.1em;margin-bottom:10px">${h.ticker}</div><div class="holding-info"><div>Shares: ${h.shares.toFixed(4)}</div><div>Price: ${fmt(h.price)}</div><div>Value: ${fmt(v)}</div></div></div><button class="delete-btn" onclick="delR(${i})">Del</button></div>`;
      }).join('');
    }

    function updKHolds(){
      let lst=document.getElementById('kList');
      if(!d.k.h.length)return lst.innerHTML='<p style="text-align:center;color:#999;padding:20px">No holdings</p>';
      lst.innerHTML=d.k.h.map((h,i)=>{
        let v=h.shares*h.price;
        return`<div class="item"><div style="flex:1"><div style="font-weight:bold;font-size:1.1em;margin-bottom:10px">${h.ticker}</div><div class="holding-info"><div>Shares: ${h.shares.toFixed(4)}</div><div>Price: ${fmt(h.price)}</div><div>Value: ${fmt(v)}</div></div></div><button class="delete-btn" onclick="delK(${i})">Del</button></div>`;
      }).join('');
    }

    function delT(i){if(confirm('Delete?')){d.c.t.splice(i,1);save();upd();}}
    function delR(i){if(confirm('Delete?')){d.r.h.splice(i,1);save();upd();}}
    function delK(i){if(confirm('Delete?')){d.k.h.splice(i,1);save();upd();}}

    function snap(c,r,k,t){
      let td=new Date().toISOString().split('T')[0];
      let idx=d.hist.findIndex(h=>h.date.startsWith(td));
      let s={date:new Date().toISOString(),checking:c,roth:r,k401:k,total:t};
      if(idx>=0)d.hist[idx]=s;else d.hist.push(s);
      if(d.hist.length>365)d.hist=d.hist.slice(-365);
    }

    function initCh(){
      ch1=new Chart(document.getElementById('chart1').getContext('2d'),{
        type:'line',data:{labels:[],datasets:[{label:'Net Worth',data:[],borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.1)',tension:0.4,fill:true}]},
        options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v.toLocaleString()}}}}
      });
      ch2=new Chart(document.getElementById('chart2').getContext('2d'),{
        type:'doughnut',data:{labels:['Checking','Roth IRA','401k'],datasets:[{data:[0,0,0],backgroundColor:['#3498db','#27ae60','#9b59b6']}]},
        options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'}}}
      });
      ch3=new Chart(document.getElementById('chart3').getContext('2d'),{
        type:'doughnut',data:{labels:['Income','Expenses'],datasets:[{data:[0,0],backgroundColor:['#27ae60','#e74c3c']}]},
        options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'}}}
      });
    }

    function updCh(){
      let h=[...d.hist].sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(-30);
      ch1.data.labels=h.map(x=>fmtDS(x.date));
      ch1.data.datasets[0].data=h.map(x=>x.total);
      ch1.update();
      ch2.data.datasets[0].data=[calcBal(),calcRVal(),calcKVal()];
      ch2.update();
      ch3.data.datasets[0].data=[calcInc(),calcExp()];
      ch3.update();
    }

    function fmt(v){return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(v);}
    function fmtD(s){return new Date(s).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true});}
    function fmtDS(s){return new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric'});}
    function save(){localStorage.setItem('nwt',JSON.stringify(d));}
    function load(){let s=localStorage.getItem('nwt');if(s)d=JSON.parse(s);}
  </script>
</body>
</html>